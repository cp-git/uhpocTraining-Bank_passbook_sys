package com.cpa.repository;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;

import org.postgresql.util.PSQLException;

import com.cpa.connectionpooling.DBManager;
import com.cpa.exception.CPException;

public class CustRepo {

	public static void main(String[] args) throws SQLException {
		CustRepo custRepo = new CustRepo();
//		custRepo.getAllCustomers();
//		System.out.println(custRepo.isCustExist("9865326589"));;
		custRepo.insertCustomer("Kshitija", "Talera Nagar",  "Talera Nagar", "Pune", "7523693310");
	}
	
	public void getAllCustomers() {

		DBManager dbm = null;
		Connection con = null;
		Statement st = null;
		ResultSet rs = null;

		int flag = 1;
		
		try {

			dbm = DBManager.getDBManager();
			con = dbm.getConnection();
			st = con.createStatement();
			rs = st.executeQuery("select * from customer");
//			final String SQL_LAST_ENTRY = "SELECT account_number FROM customer WHERE cust_seq_id=(SELECT MAX(cust_seq_id) FROM customer)";
//			rs = st.executeQuery(SQL_LAST_ENTRY);
//			System.out.println(SQL_LAST_ENTRY);
			while (rs.next()) {
							
			
					rs.getInt(1);
					rs.getInt(2);
					rs.getString(1);
					rs.getString(4);
					
					System.out.println(rs.getInt(1)+" "+rs.getInt(2)+" "+rs.getString(3)+" "+rs.getString(4)+" "+rs.getLong("phone"));
				System.out.println(rs.getString(1));	
			}
		} catch (CPException exp) {
			exp.printStackTrace();
		} catch (Exception exp1) {
			exp1.printStackTrace();
		} finally {
			dbm.closeConnection(con);
			try {
				rs.close();
				st.close();
			} catch (Exception exp) {

			}
		}

	}

	
	public boolean isCustExist(String phone) {

		DBManager dbm = null;
		Connection con = null;
		Statement st = null;
		ResultSet rs = null;

		int flag = 1;
		
		try {

			dbm = DBManager.getDBManager();
			con = dbm.getConnection();
			st = con.createStatement();
			rs = st.executeQuery("select * from customer");
			while (rs.next()) {
				

				

				
				String db_customer_phone = Long.toString(rs.getLong("phone"));
				
				System.out.println(db_customer_phone);
				if ( (db_customer_phone.equals(phone)) == true) {
					flag = 0;
					
				}
				
				System.out.println(flag);

			}
		} catch (CPException exp) {
			exp.printStackTrace();
		} catch (Exception exp1) {
			exp1.printStackTrace();
		} finally {
			dbm.closeConnection(con);
			try {
				rs.close();
				st.close();
			} catch (Exception exp) {

			}
		}

		return (flag == 0) ? true : false;
	}

	
	public void insertCustomer(String customer_name, String customer_address1,String customer_address2, String customer_city, String customer_phone) throws SQLException {
			DBManager dbm = null;
			Connection con = null;
			boolean action = false;
			ResultSet rs = null;
			PreparedStatement st =null;
		
			
			final String SQL_INSERT = "INSERT INTO customer (bank_id, account_number, cust_name,address1 , address2, city, phone) VALUES (?,?,?,?,?,?,?)";
			
			try {

				dbm = DBManager.getDBManager();
				con = dbm.getConnection();
				Statement st1 = con.createStatement();
				st= con.prepareStatement(SQL_INSERT);

				st.setInt(1,1);
				st.setString(2,"BOIN003");
				st.setString(3, customer_name);
				st.setString(4, customer_address1);
				st.setString(5, customer_address2);
				st.setString(6, customer_city);
				st.setLong(7,Long.parseLong(customer_phone));
				

//				action = st.executeUpdate();
				
				action = st.execute();
				System.out.println("company inserted successfully");
				
				
//				if(action == true){
//					
//					final String SQL_LAST_ENTRY = "SELECT cust_seq_id FROM customer WHERE cust_seq_id=(SELECT MAX(cust_seq_id) FROM customer)";
//					rs = st1.executeQuery(SQL_LAST_ENTRY);
//					long last_cust_seq_id = rs.getLong(1);
//
//					String updated_account_number = "BOIN00"+ Long.toString(last_cust_seq_id);
//					System.out.println(updated_account_number);
//					//final String SQL_UPDATE = "UPDATE customer SET account_number ="+"'"+updated_account_number+"'"+ "WHERE cust_seq_id = "+last_cust_seq_id;
//					
//					
//			}
//				
				
		//		final String SQL_LAST_ENTRY = "SELECT account_number FROM customer WHERE cust_seq_id SELECT MAX(cust_seq_id) customer";

			} 
			
			
			catch (CPException exp) {
				exp.printStackTrace();
				
			} 
//			catch(PSQLException psqlException)
//			{
//				System.out.println("Company Creation failed ");
//				
//				}
			catch (Exception exp1) {
				exp1.printStackTrace();
			} finally {
				dbm.closeConnection(con);

			}
		
		}
}
