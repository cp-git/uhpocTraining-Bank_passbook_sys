package com.cpa.repository;

import java.io.FileInputStream;
import java.io.IOException;
import java.sql.Connection;
import java.sql.Date;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.Properties;

import org.postgresql.util.PSQLException;

import com.cpa.connectionpooling.DBManager;
import com.cpa.entity.Transaction;
import com.cpa.exception.CPException;

public class TransRepo {

	
	
	//FUNCTION TO RETRIEVE ALL ENTRIES IN TRANSACTION TABLE
		public ArrayList<Transaction> getAllTransactions() {

			DBManager dbm = null;
			Connection con = null;
			Statement st = null;
			ResultSet rs = null;
			ArrayList<Transaction> tranList = new ArrayList<Transaction>();

			int flag = 1;

			try {

				dbm = DBManager.getDBManager();
				con = dbm.getConnection();
				st = con.createStatement();
				rs = st.executeQuery("select * from transaction");
				
				// final String SQL_LAST_ENTRY = "SELECT account_number FROM customer WHERE
				// cust_seq_id=(SELECT MAX(cust_seq_id) FROM customer)";
				// rs = st.executeQuery(SQL_LAST_ENTRY);
				// System.out.println(SQL_LAST_ENTRY);
				while (rs.next()) {
					Transaction transaction = new Transaction();
					
					int db_cust_seq_id = rs.getInt("cust_seq_id");
					transaction.setCust_seq_id(db_cust_seq_id);
					
					Date db_tran_date = rs.getDate("tran_date");
					transaction.setTran_date(db_tran_date);
					
					String db_tran_details = rs.getString("tran_details");
					transaction.setTran_details(db_tran_details);
					
					Double db_credit_amt = rs.getDouble("credit_amt");
					transaction.setCredit_amt(db_credit_amt);
					
					
					tranList.add(transaction);
					
				


				}
			} catch (CPException exp) {
				exp.printStackTrace();
			} catch (Exception exp1) {
				exp1.printStackTrace();
			} finally {
				dbm.closeConnection(con);
				try {
					rs.close();
					st.close();
				} catch (Exception exp) {

				}
			}
			return tranList ;

		}
		
		
		//FUNCTION TO INSERT NEW TRANSACTION
		public String insertTransaction(int cust_seq_id, Date tran_date, String tran_details,Double credit_amt,Double debit_amt ) throws SQLException, IOException {
			DBManager dbm = null;
			Connection con = null;
			boolean action = false;
			ResultSet rs = null;
			PreparedStatement st = null;
			
			
			final String SQL_INSERT = "INSERT INTO customer (cust_seq_id,tran_date,tran_details,credit_amt,debit_amt) VALUES (?,?,?,?,?)";

			try {

				dbm = DBManager.getDBManager();
				con = dbm.getConnection();
				Statement st1 = con.createStatement();
				st = con.prepareStatement(SQL_INSERT);

				
				st.setInt(1, cust_seq_id);
				st.setDate(2, tran_date);
				st.setString(3, tran_details);
				st.setDouble(4, credit_amt);
				st.setDouble(5, debit_amt);

				st.executeUpdate();

		
				System.out.println("transaction inserted successfully");
				System.out.println(action);
				
				
				

			}

			catch (CPException exp) {
				exp.printStackTrace();

			}
			 catch(PSQLException psqlException)
			 {
			 System.out.println("Transaction Creation failed ");
			
			 }
			catch (Exception exp1) {
				exp1.printStackTrace();
			} finally {
				dbm.closeConnection(con);

			}
			return null;

		}

}
